<html>

<head>
  <title>股票查詢系統 - Stock Price Checker</title>
  <script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script th:src="@{/js/stocklinechart.js}"></script>
  <script th:src="@{/js/stockcandlechart.js}"></script>
  <script th:src="@{/js/OHstocklinechart.js}"></script>
  <script th:src="@{/js/OHstockcandlechart.js}"></script>


  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f4f4;
    }

    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); */
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      flex: 1;
    }

    button {
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0052a3;
    }

    .stock-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-card {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .price-up {
      color: #ff4444;
    }

    .price-down {
      color: #009900;
    }

    #chart-container {
      margin-top: 20px;
      height: 80%;
    }

    .chart-container {
      width: 100%;
      height: 400px;
    }

    .tv-lightweight-charts {
      width: 100% !important;
      max-width: 100% !important;
    }

    .stock-charts {
      padding: 0;
      margin: 0;
      list-style: none;
    }

    .stock-item,
    .stock-chart-item {
      width: 100%;
      margin-bottom: 20px;
      h3 {
        font-size: 0;
      }
    }

   

    .chart-container {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      position: relative;
    }

    .select2-container .select2-selection--single {
      height: 34px !important;
    }

    .select2-container--default .select2-selection--single {
      border: 1px solid #ccc !important;
      border-radius: 0px !important;
    }

    .help-icon {
      /* background: none; */
      border: none;
      padding: 0;
      margin-left: 8px;
      cursor: pointer;
      position: relative;
    }

    .help-icon .search-icon {
      pointer-events: none;
    }

    .tooltip {
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      transform: translateY(5px);
      position: absolute;
      bottom: 100%;
      left: 0;
      margin-bottom: 5px;
      background: rgba(10, 10, 32, 0.95);
      color: #fff;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      border: 1px solid rgba(0, 255, 157, 0.3);
      box-shadow: 0 2px 10px rgba(0, 255, 157, 0.2);
    }

    @media (hover: hover) {
      .help-icon:hover .tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
    }

    

    
  </style>
</head>

<body>
  <div class="container">
    <h1>股票查詢系統</h1>

    <div class="container">
      <div class="row">
        <form class="col-md-4" method="get" th:action="@{/search}" style="display: flex; align-items: center;">
          <!-- <label>Select</label> -->
          <select class="form-control select2" name="keyword" onchange="this.form.submit()">
            <!-- <option th:each="${dto}"></option> -->
            <!-- <option th:each="stock : ${list}" th:value="${stock.symbol}" th:text="${stock.symbol}"
              th:selected="${stock.symbol == DTO}"> -->
             <!--  <option th:each="stock : ${symbols}" th:value="${stock.key}" th:data-company="${stock.value}" th:text="${stock.key}"
              th:selected="${stock.key == DTO}">
            </option> -->
            <option th:each="stock : ${symbols}"
                    th:value="${stock.key}"
                    th:selected="${stock.key == DTO}">
              [[${stock.key}]] - <i>[[${stock.value}]]</i>
            </option>
          </select>
          
          <!-- <span  title="請輸入股票代號或股票名稱" style="margin-left: 8px; cursor: help;"><svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11h2v5m-2 0h4m-2.592-8.5h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
          </svg>
          </span> -->
          <button type="button" class="help-icon" onclick="toggleTooltip()">
            <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11h2v5m-2 0h4m-2.592-8.5h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
            </svg>
            <span id="tooltip" class="tooltip">請輸入股票代號或股票名稱</span>
          </button>
        </form>
      </div>
    </div>

    <!-- <div class="search-box">
      <form method="get" th:action="@{/search}">
      
        <div class="search-container">
          <input type="text" id="stockSymbol" name="keyword" 
                   placeholder="輸入股票代碼 (例如: 0388.HK)" 
                   th:value="${keyword}"
                   autocomplete="off"
                   >
          <button  type="submit">查詢</button>
          
        </div>
        <select name="symbol" onchange="this.form.submit()">
          
         </select> -->





    <!-- <button onclick="searchStock()">查詢</button> 
       
      </form>
    </div> -->

    <div class="stock-info" method="get" th:action="@{/search}">
      <div class="info-card">
        <h3>股票名稱</h3>
        <p id="stockName" th:text="${LongName} " >--</p>
      </div>
      <div class="info-card">
        <h3>現價</h3>
        <p id="currentPrice" th:text="|$  ${currentPrice}|">--</p>
      </div>
      <div class="info-card">
        <h3>漲跌幅</h3>
        <p id="priceChange" th:text="|${currentChange}%| "
          th:classappend="${pricedecrease} ? 'price-down' : 'price-up'">--</p>
      </div>
    </div>

    <div id="chart-container" class="chart-container">
      <div class="chart-wrapper">
        <h4 class="chart-title"  th:text="'股票走勢圖 - ' + (${DTO} ? ${DTO} : '0388.HK')"></h4>
        <div class="row">
          <div class="col">
            <nav>
              <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" id="nav-1-tab" data-bs-toggle="tab" data-bs-target="#nav-1"
                  type="button" role="tab" aria-controls="nav-" aria-selected="true">5分鐘走勢(1日)</button>
                <button class="nav-link" id="nav-2-tab" data-bs-toggle="tab" data-bs-target="#nav-2" type="button"
                  role="tab" aria-controls="nav-2" aria-selected="false">過去3個月走勢(1日)</button>

              </div>
            </nav>
          </div>
          <div class="col col-lg-2">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked" name="showCandlestick">
              <label style="font-size: small;" class="form-check-label" for="flexSwitchCheckChecked">切換至陰陽燭</label>
            </div>
          </div>
        </div>


        <div class="tab-content" id="nav-tabContent">
          <div class="tab-pane fade py-3 active show" id="nav-1" role="tabpanel" aria-labelledby="nav-1-tab"
            tabindex="0">
            <!-- <div th:if="${not showCandlestick}" th:replace="stocklinechart :: #stock-charts" id="stock-charts" ></div>
            <div th:if="${showCandlestick}" th:replace="stockcandlechart :: #stock-candlecharts" id="candle-charts" style="display: none;"></div> -->
            <!-- <div  th:replace="stocklinechart :: #stock-charts" id="stock-charts" ></div> -->
            <div id="stocklinechart-area">
              <div th:replace="stocklinechart :: #stock-charts" id="stocklinechart-charts"></div>
            </div>
            <div id="stockcandlechart-area" style="display: none;">
              <div th:replace="stockcandlechart :: #stock-candlecharts" id="stockcandlechart-charts"></div>
            </div>
          </div>
          <div class="tab-pane fade py-3" id="nav-2" role="tabpanel" aria-labelledby="nav-2-tab" tabindex="0">
            <!-- <div th:replace="OHstocklinechart :: #OHstock-charts"></div> -->
            <div>
              <div id="OHstocklinechart-area">
                <div th:replace="OHstocklinechart :: #OHstock-charts" id="OHstocklinechart-charts"></div>
              </div>
              <div id="OHstockcandlechart-area" style="display: none;">
                <div th:replace="OHstockcandlechart :: #OHstock-candlecharts" id="OHstockcandlechart-charts"></div>
              </div>
            </div>

          </div>
          <!-- <div th:replace="stocklinechart :: #stock-charts"></div> -->
        </div>
      </div>
    </div>

    <script>
      //$('.select2').select2();
      /* $(document).ready(function() {
        $('.select2').select2();
        
        // Set the selected value if there's a keyword in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const keyword = urlParams.get('keyword');
        if (keyword) {
          $('.select2').val(keyword).trigger('change');
        }
      }); */

      document.addEventListener("DOMContentLoaded", function () {
        // 初始化選擇器
        /* $('.select2').select2({
          matcher: function(params, data) {
            if ($.trim(params.term) === '') {
              return data;
            }

            const term = params.term.toLowerCase();
            const text = data.text.toLowerCase();
            const company = $(data.element).data('company')?.toLowerCase() || '';

            if (text.includes(term) || company.includes(term)) {
              return data;
            }

            return null;
          }
        }); */
        $('.select2').select2({
          templateResult: function (data) {
            if (!data.id) return data.text;
            var parts = data.text.split(" - ");
            return $('<span><strong>' + parts[0] + '</strong> - <em>' + parts[1] + '</em></span>');
          }
        });

        // 切換圖表顯示
        var checkbox = document.getElementById('flexSwitchCheckChecked');
        var lineArea = document.getElementById('stocklinechart-area');
        var candleArea = document.getElementById('stockcandlechart-area');
        var OHlineArea = document.getElementById('OHstocklinechart-area');
        var OHcandleArea = document.getElementById('OHstockcandlechart-area');


        //if (!checkbox || !lineArea || !candleArea) return;

        // 初始化顯示
        /* if (checkbox.checked) {
          lineArea.style.display = 'none';
          candleArea.style.display = '';
        } else {
          lineArea.style.display = '';
          candleArea.style.display = 'none';
        } */

        function updateChartVisibility() {
          if (checkbox.checked) {
            if (lineArea) lineArea.style.display = 'none';
            if (candleArea) candleArea.style.display = '';
            if (OHlineArea) OHlineArea.style.display = 'none';
            if (OHcandleArea) OHcandleArea.style.display = '';
          } else {
            if (lineArea) lineArea.style.display = '';
            if (candleArea) candleArea.style.display = 'none';
            if (OHlineArea) OHlineArea.style.display = '';
            if (OHcandleArea) OHcandleArea.style.display = 'none';
          }


        }

        updateChartVisibility();

        // 切換事件
        /* checkbox.addEventListener('change', function() {
          if (this.checked) {
            lineArea.style.display = 'none';
            candleArea.style.display = '';
          } else {
            lineArea.style.display = '';
            candleArea.style.display = 'none';
          }
        }); */

        if (checkbox) {
          checkbox.addEventListener('change', updateChartVisibility);
        }

        // 隱藏其他股票圖表的邏輯
        hideOtherStockCharts();
      });

      function hideOtherStockCharts() {
        var h4 = document.querySelector('.chart-title');
        if (!h4) return;
        var match = h4.textContent.match(/股票走勢圖\s*-\s*(.+)/);
        if (!match) return;
        var selectedSymbol = match[1].trim();

        ['#stock-charts', '#stock-candlecharts', '#OHstock-charts', '#OHstock-candlecharts'].forEach(selector => {
          var container = document.querySelector(selector);
          if (!container) return;

          container.querySelectorAll('.stock-item, .stock-chart-item').forEach(item => {
            var h3 = item.querySelector('h3');
            if (!h3) return;
            item.style.display = h3.textContent.trim() === selectedSymbol ? '' : 'none';
          });
        });

        /* document.querySelectorAll('#stock-charts .stock-item').forEach(item => {
          var h3 = item.querySelector('h3');
          if (!h3) return;
          item.style.display = h3.textContent.trim() === selectedSymbol ? '' : 'none';
        });
    
        document.querySelectorAll('#stock-candlecharts .stock-chart-item').forEach(item => {
          var h3 = item.querySelector('h3');
          if (!h3) return;
          item.style.display = h3.textContent.trim() === selectedSymbol ? '' : 'none';
        });
    
    
        document.querySelectorAll('#OHstock-charts .stock-item').forEach(item => {
          var h3 = item.querySelector('h3');
          if (!h3) return;
          item.style.display = h3.textContent.trim() === selectedSymbol ? '' : 'none';
        }); */
      }

      // 先執行一次
      document.addEventListener("DOMContentLoaded", hideOtherStockCharts);
      // 然後每隔 1 秒再執行一次
      setInterval(hideOtherStockCharts, 50);

      function toggleTooltip() {
        const tooltip = document.getElementById('tooltip');
        if (!tooltip) return;

        const isVisible = tooltip.style.opacity === '1';
        tooltip.style.opacity = isVisible ? '0' : '1';
        tooltip.style.visibility = isVisible ? 'hidden' : 'visible';
        tooltip.style.transform = isVisible ? 'translateY(5px)' : 'translateY(0)';
      }




      //     $(document).ready(function() {
      //    $('.select2').select2();
      //
      //    // 初始化時載入預設股票
      //    loadDefaultChart();
      //
      //    // 當選擇股票變化時更新圖表
      //    $('#stockSelector').on('change', function() {
      //      const symbol = $(this).val();
      //      updateChartTitle(symbol);
      //      reloadChartData(symbol);
      //    });
      //
      //    function loadDefaultChart() {
      //      const defaultSymbol = '0388.HK';
      //      updateChartTitle(defaultSymbol);
      //      // 觸發stocklinechart.js中的功能
      //      window.createStockChart(defaultSymbol, getPreloadedData(defaultSymbol));
      //    }
      //
      //    function updateChartTitle(symbol) {
      //      $('.chart-title').text(`股票走勢圖 - ${symbol}`);
      //    }
      //
      //    function reloadChartData(symbol) {
      //      // 這裡可以調用stocklinechart.js中的更新函數
      //      if (window.stockCharts && window.stockCharts[symbol]) {
      //        window.stockCharts[symbol].lineSeries.update(getNewData(symbol));
      //      } else {
      //        window.createStockChart(symbol, getNewData(symbol));
      //      }
      //    }
      //
      //    // 假設的數據獲取函數 - 實際應與您的API對接
      //    function getNewData(symbol) {
      //  // 實際API調用
      //  return fetch(`/api/stock-data?symbol=${symbol}&interval=5m`)
      //    .then(response => {
      //      if (!response.ok) throw new Error('Network response was not ok');
      //      return response.json();
      //    })
      //    .then(data => {
      //      // 轉換數據格式以匹配圖表需求
      //      return data.map(item => ({
      //        dateTime: item.timestamp,  // 根據實際API字段調整
      //        close: item.closePrice,   // 根據實際API字段調整
      //        symbol: symbol
      //      }));
      //    })
      //    .catch(error => {
      //      console.error('獲取股票數據失敗:', error);
      //      return null;
      //    });
      //}
      //
      //    function getPreloadedData(symbol) {
      //  // 從Thymeleaf獲取預先渲染的數據
      //  const preloadedData = /*[[${lineData}]]*/ null;
      //
      //  // 確保數據格式正確
      //  if (preloadedData && Array.isArray(preloadedData)) {
      //    return preloadedData.filter(item => item.symbol === symbol);
      //  }
      //
      //  return null;
      //}
      //  });

    </script>
</body>

</html>